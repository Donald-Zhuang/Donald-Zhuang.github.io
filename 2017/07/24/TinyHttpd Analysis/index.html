<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="http,tinyhttpd," />





  <link rel="alternate" href="/atom.xml" title="御风而行" type="application/atom+xml" />






<meta name="description" content="一直很好奇web的工作原理，加之这阵子也在学习Python爬虫，就有想法了解这部分的知识，所以买了一本图解HTTP。这本书简洁清晰也很形象地介绍了HTTP协议的工作流程，对零基础了解HTTP协议有着不错的引导作用。书也很薄，可以很快看完。不过纯粹通过看书学习一个协议难免会浮于表面，因此，我找了TinyHttpd的source code来了解http协议的实现和实际工作场景。">
<meta name="keywords" content="http,tinyhttpd">
<meta property="og:type" content="article">
<meta property="og:title" content="TinyHttpd源码解析">
<meta property="og:url" content="https://donald-zhuang.github.io/2017/07/24/TinyHttpd Analysis/index.html">
<meta property="og:site_name" content="御风而行">
<meta property="og:description" content="一直很好奇web的工作原理，加之这阵子也在学习Python爬虫，就有想法了解这部分的知识，所以买了一本图解HTTP。这本书简洁清晰也很形象地介绍了HTTP协议的工作流程，对零基础了解HTTP协议有着不错的引导作用。书也很薄，可以很快看完。不过纯粹通过看书学习一个协议难免会浮于表面，因此，我找了TinyHttpd的source code来了解http协议的实现和实际工作场景。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-11-10T16:00:58.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="TinyHttpd源码解析">
<meta name="twitter:description" content="一直很好奇web的工作原理，加之这阵子也在学习Python爬虫，就有想法了解这部分的知识，所以买了一本图解HTTP。这本书简洁清晰也很形象地介绍了HTTP协议的工作流程，对零基础了解HTTP协议有着不错的引导作用。书也很薄，可以很快看完。不过纯粹通过看书学习一个协议难免会浮于表面，因此，我找了TinyHttpd的source code来了解http协议的实现和实际工作场景。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://donald-zhuang.github.io/2017/07/24/TinyHttpd Analysis/"/>





  <title>TinyHttpd源码解析 | 御风而行</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">御风而行</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://donald-zhuang.github.io/2017/07/24/TinyHttpd Analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Donald.Zhuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="御风而行">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">TinyHttpd源码解析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:57:45-07:00">
                2017-07-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/爬虫/" itemprop="url" rel="index">
                    <span itemprop="name">爬虫</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/24/TinyHttpd Analysis/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2017/07/24/TinyHttpd Analysis/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/24/TinyHttpd Analysis/" class="leancloud_visitors" data-flag-title="TinyHttpd源码解析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,952 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  18 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>一直很好奇web的工作原理，加之这阵子也在学习Python爬虫，就有想法了解这部分的知识，所以买了一本图解HTTP。<br>这本书简洁清晰也很形象地介绍了HTTP协议的工作流程，对零基础了解HTTP协议有着不错的引导作用。<br>书也很薄，可以很快看完。不过纯粹通过看书学习一个协议难免会浮于表面，因此，我找了TinyHttpd的source code来了解http协议的实现和实际工作场景。<br><a id="more"></a></p>
<h3 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h3><p>一直很好奇web的工作原理，加之这阵子也在学习Python爬虫，就有想法了解这部分的知识，所以买了一本<a href="https://book.douban.com/subject/25863515" target="_blank" rel="noopener">图解HTTP</a>。这本书简洁清晰也很形象地介绍了HTTP协议的工作流程，对零基础了解HTTP协议有着不错的引导作用。书也很薄，可以很快看完。不过纯粹通过看书学习一个协议难免会浮于表面，因此，我找了<a href="http://sourceforge.net/projects/tinyhttpd/" target="_blank" rel="noopener">TinyHttpd</a>的source code来了解http协议的实现和实际工作场景。</p>
<h3 id="2-源码解析"><a href="#2-源码解析" class="headerlink" title="2. 源码解析"></a>2. 源码解析</h3><p>声明：这篇里面的代码并不是<a href="http://sourceforge.net/projects/tinyhttpd/" target="_blank" rel="noopener">TinyHttpd</a>的源码，是我自己手动临摹一遍的代码，实测跑通了。一直相信代码自己码一遍会比纯看加注释收获多一些。同时，<a href="http://sourceforge.net/projects/tinyhttpd/" target="_blank" rel="noopener">TinyHttpd</a>只有几百行，自己码一遍也不算什么。关于阅读tinyhttpd的source code，个人觉得可以以如下顺序展开：main –&gt; startup –&gt; accept_request –&gt; execute_cgi –&gt;了解cgi实现，因此本文就按照此顺序展开分享。</p>
<h4 id="主体框架-gt-main"><a href="#主体框架-gt-main" class="headerlink" title="主体框架 -&gt; main()"></a>主体框架 -&gt; main()</h4><p>main函数是整个httpd的工作框架，具体的实现流程如下， startup创建socket通信并建立端口监听 –&gt; accept等待客户端连接请求 –&gt; accept_request处理客户端http请求 –&gt; cleanup释放资源<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sever_sock = <span class="number">-1</span>;</span><br><span class="line">    u_short port = <span class="number">5277</span>;</span><br><span class="line">    <span class="keyword">int</span> client_sock = <span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_name</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> client_name_len = <span class="keyword">sizeof</span>(client_name);</span><br><span class="line">    <span class="keyword">pthread_t</span> newthread;</span><br><span class="line"> </span><br><span class="line">    sever_sock = startup(&amp;port); <span class="comment">//建立socket通讯，并进行端口监听</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"httpd running on port %d\n"</span>, port);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">       client_sock = accept(sever_sock,</span><br><span class="line">                            (struct sockaddr *)&amp;client_name,</span><br><span class="line">                            &amp;client_name_len); <span class="comment">// 接受客户端请求</span></span><br><span class="line">       <span class="keyword">if</span>(client_sock == <span class="number">-1</span>)</span><br><span class="line">       &#123;</span><br><span class="line">           error_die(<span class="string">"accept failed"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span>(pthread_create(&amp;newthread, <span class="literal">NULL</span>, accept_request, (<span class="keyword">void</span> *)&amp;client_sock) != <span class="number">0</span>) <span class="comment">// 创建子线程处理客户端请求</span></span><br><span class="line">       &#123;</span><br><span class="line">           perror(<span class="string">"pthread_create failed"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    cleanup(sever_sock); <span class="comment">// 关闭socket，释放相关资源</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"httpd stopped\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="基础通讯实现-gt-startup"><a href="#基础通讯实现-gt-startup" class="headerlink" title="基础通讯实现 -&gt; startup()"></a>基础通讯实现 -&gt; startup()</h4><p>HTTP是一个应用层协议，通过TCP/IP进行传输的。HTTP协议规定，连接请求从客户端发起，服务端提供资源响应。在客户端无请求的情况下，服务端不会主动发送响应。服务端通讯建立过程： socket创建套接字 –&gt; bind绑定套接字 –&gt; listen监听套接字 –&gt; accept等待客户端连接请求。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">startup</span><span class="params">(u_short *port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> httpd = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">name</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 创建socket描述符：采用TCP通讯方式，在第二个参数确定的情况下，第三个参数可以传0由函数自动匹配对应协议</span></span><br><span class="line">    httpd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span>( httpd == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        error_die(<span class="string">"socket failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 绑定套接字：绑定IP地址和端口号</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;name, <span class="number">0</span>, <span class="keyword">sizeof</span>(name));</span><br><span class="line">    name.sin_family = AF_INET;</span><br><span class="line">    name.sin_port   = htons(*port); <span class="comment">// 指定端口：若端口为0，则自动分配一个端口。将端口转换为网络字节序</span></span><br><span class="line">    name.sin_addr.s_addr = htonl(INADDR_ANY); <span class="comment">//IP地址：INADDR_ANY -&gt; 服务器上所有的IP对应端口号都监听</span></span><br><span class="line">    <span class="keyword">if</span>( bind(httpd,(<span class="keyword">const</span> struct sockaddr *)&amp;name, <span class="keyword">sizeof</span>(name) ) &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        error_die(<span class="string">"bind failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 若端口为0，获取自动分配的端口号</span></span><br><span class="line">    <span class="keyword">if</span>(*port == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> namelen = <span class="keyword">sizeof</span>(name);</span><br><span class="line">        <span class="keyword">if</span>( getsockname(httpd, (struct sockaddr *)&amp;name, &amp;namelen) == <span class="number">-1</span> ) <span class="comment">// 获取套接字信息</span></span><br><span class="line">        &#123;</span><br><span class="line">            error_die(<span class="string">"getsockname failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        *port = ntohs(name.sin_port); <span class="comment">// 获取端口号： 网络字节序转主机字节序</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听socket</span></span><br><span class="line">    <span class="keyword">if</span>( listen(httpd, <span class="number">5</span>) &lt; <span class="number">0</span> ) <span class="comment">// 监听httpd，等待客户端连接请求，并设置最大可排队连接数为5个</span></span><br><span class="line">    &#123;</span><br><span class="line">        error_die(<span class="string">"listen failed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> httpd;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">#### 请求处理 -&gt; accept_request() ####</span><br><span class="line">accept_request是这个httpd的主体。通过解析http请求，对应发送资源和响应。http请求报文主要由三部分组成： 报文首部（分请求起始行和可选的请求首部字段）、空行、报文主体。通常并不一定要有报文主体。请求报文中每一行都以回车换行（**CRLF**,即<span class="string">"\r\n"</span>）作为结束标志。</span><br><span class="line">``` html</span><br><span class="line">Method URL HTTP_Version&lt;CRLF&gt;    <span class="comment">// 请求起始行</span></span><br><span class="line">Header_Name: Header_Value&lt;CRLF&gt;  <span class="comment">// 请求首部字段，可选</span></span><br><span class="line">... ...</span><br><span class="line">Header_Name: Header_Value&lt;CRLF&gt;</span><br><span class="line">&lt;CRLF&gt;                           <span class="comment">// 空行，表示报文首部结束</span></span><br><span class="line">BODY                             <span class="comment">// 报文主体</span></span><br></pre></td></tr></table></figure></p>
<p>下文我们用来分析的报头首部是用wireshark抓chrome访问httpd时发出的，只有报文首部，没有报文主体。不同浏览器可能有所差异，具体可用wireshark尝试分析。<br>TinyHttpd主要是针对请求起始行进行处理。请求起始行由Method、Request-Url和Http版本信息组成，三者通过空格隔开。如下请求起始行中”GET”就是method，表示请求访问服务器的类型，用于告知服务器访问意图。”/“为URL，表示请求访问的资源，也称作Request-URL，”HTTP/1.1”表示http版本信息，用来提示客户端使用的http协议功能。<br>下面的内容为请求首部字段，是可选的，在accept_request的execute_cgi中，我们只有在处理POST请求时才会去解析这部分的内容，对于GET，我们解析请求起始行后会去清除buf中的这部分数据，避免对后续处理或者下次通讯请求造成影响。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1                // 请求起始行</span><br><span class="line">Host: 192.168.179.145:5277    // 以下为可选首部字段，格式为Header-Name： Header-Value<span class="tag">&lt;<span class="name">CRLF</span>&gt;</span></span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate, sdch</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,en;q=0.6</span><br></pre></td></tr></table></figure></p>
<p>解析请求的具体实现。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">accept_request</span><span class="params">(<span class="keyword">void</span> *pclient)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> client = *(<span class="keyword">int</span>*)pclient;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">char</span> method[<span class="number">255</span>] = &#123;<span class="number">0</span>, &#125;;</span><br><span class="line">    <span class="keyword">char</span> url[<span class="number">255</span>] = &#123;<span class="number">0</span>, &#125;;</span><br><span class="line">    <span class="keyword">char</span> path[<span class="number">255</span>] = &#123;<span class="number">0</span>, &#125;;</span><br><span class="line">    <span class="keyword">char</span> *query_string = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, cgi = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> numofchars = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    numofchars = sock_getline(client, buf, <span class="keyword">sizeof</span>(buf)); <span class="comment">// 获取一行请求报文，以LF（\n）作为结尾。 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG_ENABLE</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"recieve : %s"</span>, numofchars == <span class="number">0</span> ? <span class="string">"NULL\r\n"</span> : buf);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 对于http报文来说，第一行即为请求起始行：method url http-version</span></span><br><span class="line">    <span class="keyword">while</span>( !<span class="built_in">isspace</span>((<span class="keyword">int</span>)buf[i]) &amp;&amp; (i &lt; <span class="keyword">sizeof</span>(method) - <span class="number">1</span>) <span class="comment">// 获取请求方法</span></span><br><span class="line">        method[j++] = buf[i++];</span><br><span class="line">    method[i] = <span class="string">'\0'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// strcasecmp为忽略大小写，比较字符串是否相同，相同则返回0，否则参数1长度大于参数2时返回正值，反之返回负值。</span></span><br><span class="line">    <span class="comment">// TinyHttpd只支持GET和POST两种方法</span></span><br><span class="line">    <span class="keyword">if</span>( strcasecmp(method, <span class="string">"GET"</span>) &amp;&amp; strcasecmp(method, <span class="string">"POST"</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        bad_request(client);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 检测请求是POST还是GET，若为POST则需要CGI处理，置起对应标志</span></span><br><span class="line">    cgi = strcasecmp(method, <span class="string">"POST"</span>) == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//清除多余空格</span></span><br><span class="line">    <span class="keyword">while</span>( <span class="built_in">isspace</span>((<span class="keyword">int</span>)buf[j]) &amp;&amp; (j++ &lt; <span class="keyword">sizeof</span>(buf)) )  </span><br><span class="line">        ;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//获取URL，用于确定访问什么资源</span></span><br><span class="line">    <span class="keyword">while</span>( !<span class="built_in">isspace</span>((<span class="keyword">int</span>)buf[j]) &amp;&amp; (i &lt; <span class="keyword">sizeof</span>(url) - <span class="number">1</span>) &amp;&amp; (j &lt; <span class="keyword">sizeof</span>(buf)) )</span><br><span class="line">    &#123;</span><br><span class="line">        url[i++] = buf[j++];</span><br><span class="line">    &#125;</span><br><span class="line">    url[i] = <span class="string">'\0'</span>;</span><br><span class="line">#<span class="keyword">if</span> DEBUG_ENABLE</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Request-URL： %s\r\n"</span>, url);</span><br><span class="line">#endif</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* process the request */</span></span><br><span class="line">    <span class="keyword">if</span>(cgi == <span class="number">0</span>) <span class="comment">/* method : GET */</span></span><br><span class="line">    &#123;</span><br><span class="line">        query_string = url;</span><br><span class="line">        <span class="comment">// 若GET请求的URL带?,则表明有查询参数，须CGI处理</span></span><br><span class="line">        <span class="keyword">while</span>( (*query_string != <span class="string">'?'</span>) &amp;&amp; (*query_string != <span class="string">'\0'</span>) ) </span><br><span class="line">            query_string++;</span><br><span class="line">        <span class="keyword">if</span> (*query_string == <span class="string">'?'</span>) <span class="comment">/* should be process by CGI */</span></span><br><span class="line">        &#123;</span><br><span class="line">            cgi = <span class="number">1</span>;</span><br><span class="line">            *query_string = <span class="string">'\0'</span>;</span><br><span class="line">            query_string++; <span class="comment">//截取查询的字符串</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*以上为请求起始行的解析过程。*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将URL转化为本地资源路径path</span></span><br><span class="line">    <span class="built_in">sprintf</span>(path, <span class="string">"htdocs%s"</span>, url);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果path为目录则返回首页路径</span></span><br><span class="line">    <span class="keyword">if</span>(path[<span class="built_in">strlen</span>(path) - <span class="number">1</span>] == <span class="string">'/'</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strcat</span>(path, <span class="string">"index.html"</span>);</span><br><span class="line">    &#125; </span><br><span class="line">#<span class="keyword">if</span> DEBUG_ENABLE</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"request path: %s\r\n"</span>, path);</span><br><span class="line">#endif</span><br><span class="line">     </span><br><span class="line">    <span class="comment">//检测请求文件是否存在</span></span><br><span class="line">    <span class="keyword">if</span>(stat(path, &amp;st) == <span class="number">-1</span>)</span><br><span class="line">    &#123;    </span><br><span class="line">        <span class="comment">//文件不存在则清除剩余header信息，即可选首部字段部分。</span></span><br><span class="line">        <span class="keyword">while</span>( (numofchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>, buf) )</span><br><span class="line">        &#123;</span><br><span class="line">            numofchars = sock_getline(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        &#125;</span><br><span class="line">        not_found(client); <span class="comment">// 向浏览器声明没有相应资源</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 若请求URL为路径，则返回首页</span></span><br><span class="line">        <span class="comment">// warning： 这里有一个bug，假设URL为"htdocs/index"，本地存在这个目录，</span></span><br><span class="line">        <span class="comment">// 但不存在"htdocs/index/index.html"这里会合成之后的路径就是错的</span></span><br><span class="line">        <span class="keyword">if</span>( (st.st_mode &amp; S_IFMT) == S_IFDIR )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">strcat</span>(path, <span class="string">"/index.html"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">// 检测到文件具备可执行权限，当请求文件为可执行程序，则应执行对应程序获取执行结果</span></span><br><span class="line">        <span class="keyword">if</span>( (st.st_mode &amp; S_IXUSR ) ||    <span class="comment">// 文件所有者具备执行权限</span></span><br><span class="line">            (st.st_mode &amp; S_IXGRP ) ||    <span class="comment">// 用户组具备执行权限</span></span><br><span class="line">            (st.st_mode &amp; S_IXOTH ) )     <span class="comment">// 其他用户具备可执行权限</span></span><br><span class="line">        &#123;</span><br><span class="line">            cgi = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">#<span class="keyword">if</span> DEBUG_ENABLE</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"cgi[%d]: goto %s\r\n"</span>, cgi, cgi == <span class="number">0</span> ? <span class="string">"serve_file"</span>:<span class="string">"execute_cgi"</span>);</span><br><span class="line">#endif</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (cgi == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            serve_file(client, path); <span class="comment">// 请求文件存在且非执行，则发送文件内容</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            execute_cgi(client, path, method, query_string); <span class="comment">// 需执行CGI获取内容的</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(client);     <span class="comment">//释放客户端套接字，通讯结束</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="执行CGI"><a href="#执行CGI" class="headerlink" title="执行CGI"></a>执行CGI</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">execute_cgi</span><span class="params">( <span class="keyword">int</span> client, <span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *method, <span class="keyword">const</span> <span class="keyword">char</span> *query_string )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>]= &#123;<span class="string">'A'</span>, <span class="number">0</span>,&#125;;</span><br><span class="line">    <span class="keyword">int</span> cgi_in[<span class="number">2</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>&#125;, cgi_out[<span class="number">2</span>] = &#123;<span class="number">0</span>,<span class="number">0</span>&#125;; <span class="comment">//声明管道通讯，用于父子进程之间的通讯</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> content_length = <span class="number">-1</span>, numofchars = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> ch = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>, status;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method, <span class="string">"GET"</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//如果是GET方法，则清除剩余http头</span></span><br><span class="line">        <span class="keyword">while</span>( (numofchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>,buf) ) <span class="comment">//clean the header</span></span><br><span class="line">        &#123;</span><br><span class="line">            sock_getline(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>((numofchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(buf, <span class="string">"\n"</span>)) <span class="comment">// 解析终止条件：HTTP请求头部解析完</span></span><br><span class="line">        &#123;</span><br><span class="line">            buf[<span class="number">14</span>] = <span class="string">'\0'</span>;  <span class="comment">//strlen("content-length") == 14</span></span><br><span class="line">            <span class="comment">// 解析http头请求字段，获取content-length字段值，即实体主体大小</span></span><br><span class="line">            <span class="keyword">if</span>( <span class="number">0</span> == strcasecmp(buf, <span class="string">"content-length"</span>) ) </span><br><span class="line">            &#123;</span><br><span class="line">                content_length = atoi(&amp;buf[<span class="number">16</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            numofchars = sock_getline(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(content_length == <span class="number">-1</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//如果没有成功解析到，则表明这是一个错误请求</span></span><br><span class="line">            bad_request(client);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 响应报文，返回正确响应码200</span></span><br><span class="line">    send_str(client, <span class="string">"HTTP/1.0 200 OK\r\n"</span>); <span class="comment">// 响应报文起始行组成： HTTP-Version Status-Code Reason-Phrase</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">//pipe操作必须在fork之前，这边子进程才能继承到两组文件描述符，实现父子进程之间的通讯</span></span><br><span class="line">    <span class="keyword">if</span>( (pipe(cgi_out) &lt; <span class="number">0</span>) || (pipe(cgi_in) &lt; <span class="number">0</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//创建管道，fd[0]--&gt;读 fd[1]&lt;--写，创建失败则返回信息给客户端</span></span><br><span class="line">        cannot_execute(client);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>( (pid = fork()) &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        cannot_execute(client);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//为方便理解和阅读代码，加的定义</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_STDIN    (0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_STDOUT   (1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE_STDERR   (2)</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">char</span> meth_env[<span class="number">255</span>], query_env[<span class="number">255</span>], length_env[<span class="number">255</span>];</span><br><span class="line">        dup2(cgi_out[<span class="number">1</span>], DEFINE_STDOUT); <span class="comment">// dup2将系统标准输出定义到cgi_out[1]</span></span><br><span class="line">        close(cgi_out[<span class="number">0</span>]);               <span class="comment">// 关闭cgi_out[0],避免误操作</span></span><br><span class="line">        dup2(cgi_in[<span class="number">0</span>], DEFINE_STDIN);   <span class="comment">// 将系统标准输入定义到cgi[0]上</span></span><br><span class="line">        close(cgi_out[<span class="number">1</span>]);</span><br><span class="line"> </span><br><span class="line">        <span class="built_in">sprintf</span>(meth_env, <span class="string">"REQUEST_METHOD=%s"</span>, method); <span class="comment">//将请求方法保存在进程所在的环境变量中</span></span><br><span class="line">        putenv(meth_env);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span>( strcasecmp(method,<span class="string">"GET"</span>) == <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(query_env, <span class="string">"QUERY_STRING=%s"</span>, query_string); <span class="comment">// GET方法需提供查询的信息</span></span><br><span class="line">            putenv(query_env);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(length_env, <span class="string">"CONTENT_LENGTH=%d"</span>, content_length); <span class="comment">// POST方法提供主题的大小</span></span><br><span class="line">            putenv(length_env);</span><br><span class="line">        &#125;</span><br><span class="line">        execl(path, path, <span class="literal">NULL</span>); <span class="comment">// 执行CGI程序,同时继承了子进程的文件描述符</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 关闭两个不会操作到的pipe，避免误操作</span></span><br><span class="line">        close(cgi_in[<span class="number">0</span>]);</span><br><span class="line">        close(cgi_out[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(strcasecmp(method, <span class="string">"POST"</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; content_length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                recv(client, &amp;ch, <span class="number">1</span>, <span class="number">0</span>); <span class="comment">// POST方法需要解析报文主体实体，然后发给CGI程序</span></span><br><span class="line">                write(cgi_in[<span class="number">1</span>], &amp;ch, <span class="number">1</span>);</span><br><span class="line">                <span class="meta">#<span class="meta-keyword">if</span> DEBUG_ENABLE</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%c"</span>, ch);</span><br><span class="line">                <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(read(cgi_out[<span class="number">0</span>], &amp;ch, <span class="number">1</span>) &gt; <span class="number">0</span>) <span class="comment">// 获取CGI执行结果，并通过Socket返回客户端</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">if</span> DEBUG_ENABLE</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>, ch);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            send(client, &amp;ch, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        close(cgi_out[<span class="number">0</span>]);</span><br><span class="line">        close(cgi_in[<span class="number">1</span>]);</span><br><span class="line">        waitpid(pid, &amp;status, <span class="number">0</span>); <span class="comment">// 等待所有子进程执行完毕</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="文件发送实现"><a href="#文件发送实现" class="headerlink" title="文件发送实现"></a>文件发送实现</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cat</span><span class="params">( <span class="keyword">int</span> client, FILE *resource )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"> </span><br><span class="line">    fgets( buf, <span class="keyword">sizeof</span>(buf), resource );      <span class="comment">// 读取1024bytes数据</span></span><br><span class="line">    <span class="keyword">while</span>(!feof(resource))                    <span class="comment">// 如果文件未EOF则继续读</span></span><br><span class="line">    &#123;</span><br><span class="line">        send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);    <span class="comment">// socket传输数据</span></span><br><span class="line">        fgets(buf, <span class="keyword">sizeof</span>(buf), resource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serve_file</span><span class="params">( <span class="keyword">int</span> client, <span class="keyword">const</span> <span class="keyword">char</span> *filename )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *resource = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> numofchars = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>] = &#123;<span class="string">'A'</span>, <span class="string">'\0'</span>,&#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* read &amp; discard headers */</span></span><br><span class="line">    <span class="keyword">while</span>( (numofchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>, buf) )</span><br><span class="line">    &#123;</span><br><span class="line">        numofchars = sock_getline( client, buf, <span class="keyword">sizeof</span>(buf) ); <span class="comment">// 清除请求头。</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    resource = fopen(filename, <span class="string">"r"</span>);    <span class="comment">// 打开文件读取</span></span><br><span class="line">    <span class="keyword">if</span>( resource == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        not_found(client);              <span class="comment">// 资源未找到或无法访问</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        headers(client, filename);      <span class="comment">// 发送服务器响应报文首部</span></span><br><span class="line">        cat(client, resource);          <span class="comment">// 发送服务器响应实体主体</span></span><br><span class="line">    &#125;</span><br><span class="line">    fclose(resource);                   <span class="comment">// 释放资源</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="相关函数实现"><a href="#相关函数实现" class="headerlink" title="相关函数实现"></a>相关函数实现</h4><p>1、获取客户端请求报文的一行内容<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_getline</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">char</span> *buf, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> ch = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>((buf == <span class="literal">NULL</span>) &amp;&amp; (size == <span class="number">0</span>) &amp;&amp; (sock == <span class="number">-1</span>)) <span class="comment">// 参数合法性检查</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"parameter error, please check %s[%d]\n"</span>, __func__, __LINE__);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">while</span>( (i &lt; size - <span class="number">1</span>) &amp;&amp; (ch != <span class="string">'\n'</span>) ) <span class="comment">// \n是行结束标志</span></span><br><span class="line">    &#123;</span><br><span class="line">        n = recv(sock, &amp;ch, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(n &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(ch == <span class="string">'\r'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                n = recv(sock, &amp;ch, <span class="number">1</span>, MSG_PEEK);    <span class="comment">// MSG_PEEK可实现下次读到的，仍是此次读取到的内容</span></span><br><span class="line">                <span class="keyword">if</span>( (n &gt; <span class="number">0</span>) &amp;&amp; (ch == <span class="string">'\n'</span>) )        <span class="comment">// 若读取到的\r\n，则此次读取结束，读取到的字符为\n</span></span><br><span class="line">                &#123;</span><br><span class="line">                    recv(sock, &amp;ch, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    ch = <span class="string">'\n'</span>;                       <span class="comment">// 否则设定读取的字符为\n，读取结束</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            buf[i] = ch;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ch = <span class="string">'\n'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    buf[i] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2、服务器响应报文实现<br>为方便代码编写和阅读，我在tinyhttpd的基础上实现了下面这个函数，专门用于发送字符到socket<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_str</span><span class="params">(<span class="keyword">int</span> client, <span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> ret = send(client, str, <span class="built_in">strlen</span>(str), <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG_ENABLE</span></span><br><span class="line">    ret == <span class="built_in">strlen</span>(str) ?  <span class="number">0</span> : <span class="built_in">printf</span>(<span class="string">"send_str error[ret = 0x%02x].\r\n"</span>, ret);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*发送文件前的响应头*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">headers</span><span class="params">( <span class="keyword">int</span> client, <span class="keyword">const</span> <span class="keyword">char</span> *filename )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    (<span class="keyword">void</span>)filename;</span><br><span class="line">    send_str(client, <span class="string">"HTTP/1.0 200 OK\r\n"</span>);          <span class="comment">// 2**表示执行成功，200表示请求被正常处理</span></span><br><span class="line">    send_str(client, SERVER_STRING);</span><br><span class="line">    send_str(client, <span class="string">"Content-Type: text/html\r\n"</span>);  <span class="comment">// 发送资源的MIME为text/html，即文本类型</span></span><br><span class="line">    send_str(client, <span class="string">"\r\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 未找到文件或无法访问文件的响应报文 */</span> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">not_found</span><span class="params">(<span class="keyword">int</span> client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG_ENABLE</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"not found.\r\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 4**的状态码表明错误是客户端引发的</span></span><br><span class="line">    send_str(client, <span class="string">"HTTP/1.0 404 NOT FOUND\r\n"</span>); <span class="comment">//404表示请求的资源不存在或服务器不提供此资源访问 </span></span><br><span class="line">    send_str(client, SERVER_STRING);</span><br><span class="line">    send_str(client, <span class="string">"Content-Type: text/html\r\n"</span>);</span><br><span class="line">    send_str(client, <span class="string">"\r\n"</span>);</span><br><span class="line">    send_str(client, <span class="string">"&lt;HTML&gt;&lt;TITLE&gt;NOT FOUND&lt;/TITLE&gt;"</span>             <span class="comment">// 发送一个简单页面用于提示</span></span><br><span class="line">                     <span class="string">"&lt;BODY&gt;&lt;P&gt; the sever couldn't fullfill"</span></span><br><span class="line">                     <span class="string">"your request because the resource specified"</span></span><br><span class="line">                     <span class="string">"is unavailable or nonexistence."</span></span><br><span class="line">                     <span class="string">"&lt;/BODY&gt;&lt;/HTML&gt;\r\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 错误请求响应报文*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bad_request</span><span class="params">(<span class="keyword">int</span> client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG_ENABLE</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"bad request.\r\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 服务器不支持对应的方法或者报文语法时，会发出错误请求报文</span></span><br><span class="line">    send_str(client, <span class="string">"HTTP/1.0 400 BAD REQUEST\r\n"</span>);  <span class="comment">// 400表示请求错误或者请求的报文中存在语法错误</span></span><br><span class="line">    send_str(client, <span class="string">"Content-Type: text/html\r\n"</span>);</span><br><span class="line">    send_str(client, <span class="string">"\r\n"</span>);</span><br><span class="line">    send_str(client, <span class="string">"&lt;P&gt; Your browse sent a bad request,"</span></span><br><span class="line">            <span class="string">"such as a POST without a Content-Length.\r\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*服务器内部异常响应报文*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cannot_execute</span><span class="params">(<span class="keyword">int</span> client)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG_ENABLE</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can not execute.\r\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    send_str(client, <span class="string">"HTTP/1.0 500 Internal Server Error\r\n"</span>); <span class="comment">// 5**为服务器错误，500表示服务器在执行请求时发生错误</span></span><br><span class="line">    send_str(client, <span class="string">"Content-Type: text/html\r\n"</span>);</span><br><span class="line">    send_str(client, <span class="string">"\r\n"</span>);</span><br><span class="line">    send_str(client, <span class="string">"&lt;p&gt;error prohibited CGI execution.\r\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Donald.Zhuang
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://donald-zhuang.github.io/2017/07/24/TinyHttpd Analysis/" title="TinyHttpd源码解析">https://donald-zhuang.github.io/2017/07/24/TinyHttpd Analysis/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/http/" rel="tag"># http</a>
          
            <a href="/tags/tinyhttpd/" rel="tag"># tinyhttpd</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/02/Debug CheckList/" rel="prev" title="Debug Checklist">
                Debug Checklist <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="Donald.Zhuang" />
            
              <p class="site-author-name" itemprop="name">Donald.Zhuang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/donald-zhuang" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yukunzhuang@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-背景"><span class="nav-number">1.</span> <span class="nav-text">1. 背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-源码解析"><span class="nav-number">2.</span> <span class="nav-text">2. 源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主体框架-gt-main"><span class="nav-number">2.1.</span> <span class="nav-text">主体框架 -&gt; main()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基础通讯实现-gt-startup"><span class="nav-number">2.2.</span> <span class="nav-text">基础通讯实现 -&gt; startup()</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#执行CGI"><span class="nav-number"></span> <span class="nav-text">执行CGI</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#文件发送实现"><span class="nav-number">0.1.</span> <span class="nav-text">文件发送实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#相关函数实现"><span class="nav-number">0.2.</span> <span class="nav-text">相关函数实现</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Donald.Zhuang</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'sxusj7QM1yscw80QmXrzS7RF-gzGzoHsz',
        appKey: 'LKGpEcrVf998QJrYCHajJsT8',
        placeholder: 'Just go go',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: true,
    });
  </script>



  





  

  

  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>


  

</body>
</html>
