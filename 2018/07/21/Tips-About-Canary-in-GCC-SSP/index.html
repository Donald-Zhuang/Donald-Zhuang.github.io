<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="canary,coredump,__stack_chk_fail," />





  <link rel="alternate" href="/atom.xml" title="御风而行" type="application/atom+xml" />






<meta name="description" content="处理一个开机coredump问题时，发现是一个必现canary问题，即内存越界访问。一般这类问题发生在数组越界访问，不过这次出现的rootcause有所不同，为代码未对齐导致结构体没对齐，继而在数据传输过程中出现访问越界。bug简单，但鉴于canary是一个有趣的设计，犹如人体免疫系统的表层屏障，能有效规避一些bug，因此我便萌生兴趣系统地了解这个机制，相关学习记录成此文。">
<meta name="keywords" content="canary,coredump,__stack_chk_fail">
<meta property="og:type" content="article">
<meta property="og:title" content="GCC SSP Canary功能简介">
<meta property="og:url" content="https://donald-zhuang.github.io/2018/07/21/Tips-About-Canary-in-GCC-SSP/index.html">
<meta property="og:site_name" content="御风而行">
<meta property="og:description" content="处理一个开机coredump问题时，发现是一个必现canary问题，即内存越界访问。一般这类问题发生在数组越界访问，不过这次出现的rootcause有所不同，为代码未对齐导致结构体没对齐，继而在数据传输过程中出现访问越界。bug简单，但鉴于canary是一个有趣的设计，犹如人体免疫系统的表层屏障，能有效规避一些bug，因此我便萌生兴趣系统地了解这个机制，相关学习记录成此文。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://donald-zhuang.github.io/2018/07/21/Tips-About-Canary-in-GCC-SSP/DiffBetweenCanaryOnOff.png">
<meta property="og:image" content="https://donald-zhuang.github.io/2018/07/21/Tips-About-Canary-in-GCC-SSP/stack.png">
<meta property="og:image" content="https://donald-zhuang.github.io/2018/07/21/Tips-About-Canary-in-GCC-SSP/demoHeader.png">
<meta property="og:updated_time" content="2018-11-10T16:00:58.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GCC SSP Canary功能简介">
<meta name="twitter:description" content="处理一个开机coredump问题时，发现是一个必现canary问题，即内存越界访问。一般这类问题发生在数组越界访问，不过这次出现的rootcause有所不同，为代码未对齐导致结构体没对齐，继而在数据传输过程中出现访问越界。bug简单，但鉴于canary是一个有趣的设计，犹如人体免疫系统的表层屏障，能有效规避一些bug，因此我便萌生兴趣系统地了解这个机制，相关学习记录成此文。">
<meta name="twitter:image" content="https://donald-zhuang.github.io/2018/07/21/Tips-About-Canary-in-GCC-SSP/DiffBetweenCanaryOnOff.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://donald-zhuang.github.io/2018/07/21/Tips-About-Canary-in-GCC-SSP/"/>





  <title>GCC SSP Canary功能简介 | 御风而行</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">御风而行</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://donald-zhuang.github.io/2018/07/21/Tips-About-Canary-in-GCC-SSP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Donald.Zhuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="御风而行">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">GCC SSP Canary功能简介</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-21T14:32:04-07:00">
                2018-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术整理/" itemprop="url" rel="index">
                    <span itemprop="name">技术整理</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/21/Tips-About-Canary-in-GCC-SSP/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/07/21/Tips-About-Canary-in-GCC-SSP/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/07/21/Tips-About-Canary-in-GCC-SSP/" class="leancloud_visitors" data-flag-title="GCC SSP Canary功能简介">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,845 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  17 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>　　处理一个开机coredump问题时，发现是一个必现canary问题，即内存越界访问。一般这类问题发生在数组越界访问，不过这次出现的rootcause有所不同，为代码未对齐导致结构体没对齐，继而在数据传输过程中出现访问越界。bug简单，但鉴于canary是一个有趣的设计，犹如人体免疫系统的表层屏障，能有效规避一些bug，因此我便萌生兴趣系统地了解这个机制，相关学习记录成此文。<br><a id="more"></a><br>　　这篇文章首先会介绍canary的基本原理、使能方式、运行机制、canary值产生原理，最后通过gdb一个实例完整解析整个运行流程，阐释debug过程，后续我也争取更加详细阐述canary一些设计的深入原理和目的。Hope you can enjoy it.</p>
<h3 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h3><p>　　我遇到的实际问题如下，可以看到<strong>__stack_chk_fail</strong>的字眼，也就是canary问题的标志，这类问题就是栈内存越界访问导致，一般出现在数组越界上，不过这次我们遇到的是代码对齐问题。debug时我看了下code，猜原因，然后对代码就找到rootcause。实际对canary熟悉后，基本可以很快定位问题。此次分析不会提供原始问题代码，毕竟直接晒公司代码是要收律师函的。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  0xea36bd5c in raise () from /lib/libc.so.6</span><br><span class="line">#1  0xea36f838 in abort () from /lib/libc.so.6</span><br><span class="line">#<span class="number">2</span>  <span class="number">0xea3a32cc</span> in ?? () from /lib/libc.so<span class="number">.6</span></span><br><span class="line">#<span class="number">3</span>  <span class="number">0xea4212e0</span> in __fortify_fail () from /lib/libc.so<span class="number">.6</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0xea42129c</span> in __stack_chk_fail () from /lib/libc.so<span class="number">.6</span></span><br><span class="line">#<span class="number">5</span>  <span class="number">0xecd173dc</span> <span class="function">in <span class="title">XXX_HAL_AUD_SetGeqEnable</span> <span class="params">(ePort=XXX_MW_SND_OUTPORT_I2S1,</span></span></span><br><span class="line">    bOnOff=XXX_TRUE) at src/xxx_hal_audio.c:976</span><br><span class="line">#<span class="number">6</span>  <span class="number">0xee9d8428</span> in XxxAudioCtrl::GEQAef::setGEQEnable (<span class="keyword">this</span>=<span class="number">0xe6400590</span>,</span><br><span class="line">    bOnoff=bOnoff@entry=XXX_TRUE)</span><br><span class="line">    at ../middleware/sdkctrl/xxx_mw_audioctrl.cpp:<span class="number">2200</span></span><br><span class="line">#<span class="number">7</span>  <span class="number">0xee9d9168</span> <span class="function">in <span class="title">setSndEffect</span> <span class="params">(pctSndModeParam=&lt;optimized out&gt;)</span></span></span><br><span class="line">    at ../middleware/sdkctrl/xxx_mw_audioctrl.cpp:423</span><br><span class="line">#<span class="number">8</span>  <span class="number">0xeeaa5efc</span> <span class="function">in <span class="title">setSndModeSetting</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ptSndModeSetting=ptSndModeSetting@entry=<span class="number">0xe587ecd4</span>)</span></span></span><br><span class="line">    at ../middleware/setting/xxx_mw_audio.cpp:4181</span><br></pre></td></tr></table></figure></p>
<h3 id="2-GCC-SSP的canary基本原理"><a href="#2-GCC-SSP的canary基本原理" class="headerlink" title="2. GCC SSP的canary基本原理"></a>2. GCC SSP的canary基本原理</h3><p>　　Stack Canary是GCC <a href="https://wiki.osdev.org/Stack_Smashing_Protector" target="_blank" rel="noopener">Smash Stack Protector(SSP)</a>机制的一个组成部分。通过在loader加载程序时给进程预留一个随机数，称为Canary，当进程内各个函数做栈初始化时，GCC SSP在局部变量和EBP之间插入该值，并在函数返回时，取出该值检查是否被改写，以此判定是否发生内存越界访问等相关问题。下面我们将通过一个实例来解析其实现，文章采用的系统环境如下。</p>
<blockquote>
<p>Linux version 4.4.0-119-generic (buildd@lcy01-amd64-013)<br>gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.9)</p>
</blockquote>
<p>　　关于测试采用的代码如下。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* filename: Canary_demo_naive.c */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">canaryTest</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">20</span>];</span><br><span class="line">    str[<span class="number">0</span>]  = <span class="number">0xAB</span>;</span><br><span class="line">    str[<span class="number">18</span>] = <span class="number">0xBC</span>;</span><br><span class="line">    str[<span class="number">19</span>] = <span class="number">0xEF</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;                         </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    canaryTest();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2-1-功能使能方式"><a href="#2-1-功能使能方式" class="headerlink" title="2.1 功能使能方式"></a>2.1 功能使能方式</h4><p>　　canary功能分两个阶段实现，</p>
<blockquote>
<ol>
<li>编译阶段通过相关编译开关使能SSP，在满足条件的函数中嵌入代码</li>
<li>在运行阶段检测实现，运行到相关代码检测是否发生栈越界访问，是则终止程序执行(abort)</li>
</ol>
</blockquote>
<p>　　编译阶段，通过如下编译开关控制需要在哪些函数上加保护，目前常用的开关有如下几种，相关详细介绍可以参考<a href="https://lwn.net/Articles/584225/" target="_blank" rel="noopener">“Strong” stack protection for GCC</a>, 实际还有另外两种功能，不过比较少用，不做介绍。</p>
<blockquote>
<ol>
<li>-fstack-protector (GCC 4.1): 当函数定义大小大于等于8字节的数组时使能Canary，当然也可以通过–param=ssp-buffer-size=N 来控制对应的起效阈值</li>
<li>-fstack-protector-all: 对所有非内联函数使能Canary</li>
<li>-fstack-protector-strong (GCC 4.9): 满足以下三个条件都会插入保护代码，相对前两种具有更好的表现，其相关历史可参考<a href="https://outflux.net/blog/archives/2014/01/27/fstack-protector-strong/" target="_blank" rel="noopener">Kees Cook blog</a><br>1) 局部变量的地址作为赋值语句的右值或函数参数；<br>2) 局部变量为数组或含数组的数据类型，忽略数组的长度和类型；<br>3) 带register声明的局部变量</li>
<li>-fno-stack-protector: 禁用canary功能</li>
</ol>
</blockquote>
<p>　　对上文的Canary_demo_naive.c采用gcc -S Canary_demo_naive.s Canary_demo_naive.c和gcc -S Canary_demo_naive-no.s Canary_demo_naive.c -fno-stack-protector，比较编译出来的差异如下。<br><img src="/2018/07/21/Tips-About-Canary-in-GCC-SSP/DiffBetweenCanaryOnOff.png" title="The difference about Canary function"><br>　　依据上图左侧汇编代码，我们可以画出如下内存分布图。初始化阶段，从FS[40]抓取一个64bit的random值(canary)保存在栈底，返回时取出该值与FS[40]比较，若该值发生变化，调用__stack_chk_fail报错退出程序。显而易见，当出现越界访问时，canary值会被改写，检测机制生效，这也就是SSP Canary的运行阶段的实现原理。<br><img src="/2018/07/21/Tips-About-Canary-in-GCC-SSP/stack.png" title="The Stack"></p>
<h4 id="2-2-功能缺陷"><a href="#2-2-功能缺陷" class="headerlink" title="2.2 功能缺陷"></a>2.2 功能缺陷</h4><p>　　再看回上文汇编部分。我们申请的是一个20 bytes数组，考虑canary的8 bytes，则分配时应该是28 bytes，但编译器申请的是32字节，经过几次测试我发现，编译器分配的长度是满足申请所需的最小16n bytes。<br>　　这个实现会出现什么问题呢？如果我们所需的字节数加上8刚好等于16n时，一越界，canary就会被才到，功能正常。但如果所需长度小于16n，就会出现gap，当越界访问不超越这个gap，就会出现检测不到越界的问题。Canary_demo_naive.c中越界访问str[23]是检测不到的，只有在写str[24]真正踩到canary时才会报错。</p>
<h4 id="2-3-canary的产生"><a href="#2-3-canary的产生" class="headerlink" title="2.3 canary的产生"></a>2.3 canary的产生</h4><h5 id="2-3-1-Canary常见类型"><a href="#2-3-1-Canary常见类型" class="headerlink" title="2.3.1 Canary常见类型"></a>2.3.1 Canary常见类型</h5><p>　　Canary的类型主要有三种，Terminator canaries、Random canaries、Random XOR canaries。后面我们可以看到GCC源码中Terminator和Random XOR有相应实现，三者区别如下。<br>　　<strong>Terminator canaries</strong>：缓冲区溢出攻击中大部分是通过字符串操作实现，基于此，Terminator Canary通过NULL、CR、LF或-1的组合形成。攻击者若想绕过Canary检查，则必须在其攻击字串中加入NULL，而strcpy类函数都是以NULL为字符串结束符，这样就成功规避了此类针对标准库函数的漏洞利用。<br>　　<strong>Random canaries</strong>：Terminator的缺点在于值固定且可知，攻击者可通过其他方式（memcpy）绕过，因此Random Canary应运而生。一般来说，Random Canary产生于一个熵值足够大的随机数发生源，在程序初始化阶段保存在一个不可读的位置，并留存在一个全局变量中，而后者也就意味着攻击者依旧有机会获取到这个值，但实际已经能隔绝大部分攻击。<br>　　<strong>Random XOR canaries</strong>：在随机数的基础上，将之与部分控制符通过XOR操作形成，这样攻击难度进一步提升，攻击者需要获取到随机数、控制符和对应算法才能获取到对应的Canary值来实现绕过。<br>　　实际上，GCC中采用了Random配合Terminator的方式实现Canary值的生成和使用。</p>
<h5 id="2-3-2-GCC-Canary生成原理"><a href="#2-3-2-GCC-Canary生成原理" class="headerlink" title="2.3.2 GCC Canary生成原理"></a>2.3.2 GCC Canary生成原理</h5><p>　　在了解了其工作原理和类型，接下来介绍GCC中Canary这个值的来源。我们前面提到是通过FS[40]获取到的，那FS[40]这个值又是从何而来？<br>　　因为这个值在main函数中就会被用到，因此其产生早于main函数。我们也知道，main()并不是进程运行的第一个函数，其在linux中的启动过程为 <strong>_start -&gt; <strong>libc_start_main -&gt; </strong>libc_csu_init -&gt; _init -&gt; main -&gt; _fini</strong>，更具体可以通过文章<a href="https://blog.csdn.net/gary_ygl/article/details/8506007" target="_blank" rel="noopener">linux编程之main()函数启动过程</a>了解。而<strong>__libc_start_main</strong>之后的流程实现于glibc。有这个基础后，我们可以通过glibc-2.27的源码，了解Canary值的来源。<br>　　首先我们来了解下FS这个寄存器存放的基址是什么东西，通过flow <strong><strong>libc_start_main &gt;&gt; </strong>libc_setup_tls &gt;&gt; TLS_INIT_TP</strong>，看到TLS_INIT_TP这个宏的实现如下，如下位置将%fs的基址设置为TLS。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Code to initially initialize the thread pointer.  This might need</span></span><br><span class="line"><span class="comment">   special attention since 'errno' is not yet available and if the</span></span><br><span class="line"><span class="comment">   operation can cause a failure 'errno' must not be touched.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   We have to make the syscall for both uses of the macro since the</span></span><br><span class="line"><span class="comment">   address might be (and probably is) different.  */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> TLS_INIT_TP(thrdescr) \</span></span><br><span class="line">  (&#123; <span class="keyword">void</span> *_thrdescr = (thrdescr);					      \</span><br><span class="line">     <span class="keyword">tcbhead_t</span> *_head = _thrdescr;					      \</span><br><span class="line">     <span class="keyword">int</span> _result;							      \</span><br><span class="line">									      \</span><br><span class="line">     _head-&gt;tcb = _thrdescr;						      \</span><br><span class="line">     <span class="comment">/* For now the thread descriptor is at the same address.  */</span>	      \</span><br><span class="line">     _head-&gt;self = _thrdescr;						      \</span><br><span class="line">									      \</span><br><span class="line">     <span class="comment">/* It is a simple syscall to set the %fs value for the thread.  */</span>	      \</span><br><span class="line">     <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="string">"syscall"</span>						      \</span><br><span class="line">		   : <span class="string">"=a"</span> (_result)					      \</span><br><span class="line">		   : <span class="string">"0"</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span>) __NR_arch_prctl),		      \</span><br><span class="line">		     <span class="string">"D"</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span>) ARCH_SET_FS),		      \</span><br><span class="line">		     <span class="string">"S"</span> (_thrdescr)					      \</span><br><span class="line">		   : <span class="string">"memory"</span>, <span class="string">"cc"</span>, <span class="string">"r11"</span>, <span class="string">"cx"</span>);			      \</span><br><span class="line">									      \</span><br><span class="line">    _result ? <span class="string">"cannot set %fs base address for thread-local storage"</span> : <span class="number">0</span>;     \</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure></p>
<p>　　通过上面宏我们可以看到该基址指向的数据类型为tcbhead_t，对应数据结构如下,因为我的系统是x86_64，因此计算对应的偏移可得FS[40]对应的成员是stack_guard。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">void</span> *tcb;		<span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">			   thread descriptor used by libpthread.  */</span></span><br><span class="line">  <span class="keyword">dtv_t</span> *dtv;</span><br><span class="line">  <span class="keyword">void</span> *self;		<span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">  <span class="keyword">int</span> multiple_threads;</span><br><span class="line">  <span class="keyword">int</span> gscope_flag;</span><br><span class="line">  <span class="keyword">uintptr_t</span> sysinfo;</span><br><span class="line">  <span class="keyword">uintptr_t</span> stack_guard;</span><br><span class="line">  <span class="keyword">uintptr_t</span> pointer_guard;</span><br><span class="line">  ........</span><br><span class="line">  <span class="keyword">void</span> *__padding[<span class="number">8</span>];</span><br><span class="line">&#125; <span class="keyword">tcbhead_t</span>;</span><br></pre></td></tr></table></figure></p>
<p>　　而stack_guard是通过如下代码设置。其中，_dl_random为_dl_sysdep_start函数从内核获取到的一个随机数，经_dl_setup_stack_chk_guard计算生成canary，再通过THREAD_SET_STACK_GUARD宏则将canary赋值%fs:0x28。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* Set up the stack checker's canary.  */</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> stack_chk_guard = _dl_setup_stack_chk_guard (_dl_random);</span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> THREAD_SET_STACK_GUARD</span></span><br><span class="line">  THREAD_SET_STACK_GUARD (stack_chk_guard);</span><br><span class="line"><span class="meta"># <span class="meta-keyword">else</span></span></span><br><span class="line">  __stack_chk_guard = stack_chk_guard;</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>　　_dl_setup_stack_chk_guard实现如下，可以看到有两种实现方式，当_dl_random为空时，Canary取值为0xff10，否则将_dl_random低8 bits置0算得canary，这样能保证最后一个字节是’\0’，也就是终止符。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">uintptr_t</span> __attribute__ ((always_inline))</span><br><span class="line">_dl_setup_stack_chk_guard (<span class="keyword">void</span> *dl_random)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">union</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">uintptr_t</span> num;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> bytes[<span class="keyword">sizeof</span> (<span class="keyword">uintptr_t</span>)];</span><br><span class="line">  &#125; ret = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dl_random == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      ret.bytes[<span class="keyword">sizeof</span> (ret) - <span class="number">1</span>] = <span class="number">255</span>;</span><br><span class="line">      ret.bytes[<span class="keyword">sizeof</span> (ret) - <span class="number">2</span>] = <span class="string">'\n'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">memcpy</span> (ret.bytes, dl_random, <span class="keyword">sizeof</span> (ret));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BYTE_ORDER == LITTLE_ENDIAN</span></span><br><span class="line">      ret.num &amp;= ~(<span class="keyword">uintptr_t</span>) <span class="number">0xff</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> BYTE_ORDER == BIG_ENDIAN</span></span><br><span class="line">      ret.num &amp;= ~((<span class="keyword">uintptr_t</span>) <span class="number">0xff</span> &lt;&lt; (<span class="number">8</span> * (<span class="keyword">sizeof</span> (ret) - <span class="number">1</span>)));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">error</span> <span class="meta-string">"BYTE_ORDER unknown"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> ret.num;</span><br></pre></td></tr></table></figure></p>
<p>　　至此，我们完成对canary的基本介绍，接下来我们将通过一个demo模拟canary越界访问，也就是文章开头那个bug。</p>
<h3 id="3-Canary-Bug-一例"><a href="#3-Canary-Bug-一例" class="headerlink" title="3. Canary Bug 一例"></a>3. Canary Bug 一例</h3><p>　　<a href="CanaryBugDemo.rar" title="Canary Bug Demo">点击下载</a><br>　　实际工作中，除了客制化和非关键的代码会开源给客户，一些涉及关键算法的代码会以库的方式提供，这些库会在不同工程被引用，因此当底层代码更新时，特别是数据结构、数据类型发生变化是，需要及时同步头文件和库到不同的工程中，保证代码对齐。否则，会出现各种难以预料的bug，我接手这个项目处理的第一个问题就是这类问题。<br>　　我们可以看到demo中，libDemoCanary.c是以.so方式release的，其对应的头文件libDemoCanary.h。为了模拟没有对齐的情况，我再增加了一个libDemoCanary2.h，canary_demo.c包含该头文件，下图可以看到该demo差异一个char型。<br><img src="/2018/07/21/Tips-About-Canary-in-GCC-SSP/demoHeader.png" title="The difference between two headers"><br>　make产生canary_demo，执行产生coredump，当没有开启canary我们抓到的会是一个segment fault，开后会出现stack smashing detected。解析coredump如下，我们可以看到异常发生在main中，而不是发生在overWriteData()中，因为后者定义合法，内存申请大小匹配，但对于main来说，数据则超过了其栈空间，出现异常。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">donald-zhuang@ubuntu:~/Desktop/canary_demo/final$ ./canary_demo </span><br><span class="line">*** <span class="built_in">stack</span> smashing detected ***: ./canary_demo terminated</span><br><span class="line">Aborted (core dumped)</span><br><span class="line"></span><br><span class="line">donald-zhuang@ubuntu:~/Desktop/canary_demo/final$ gdb ./canary_demo core </span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</span><br><span class="line">Reading symbols from ./canary_demo...done.</span><br><span class="line">[New LWP <span class="number">9940</span>]</span><br><span class="line">Core was generated by `./canary_demo<span class="string">'.</span></span><br><span class="line">Program terminated with signal SIGABRT, Aborted.</span><br><span class="line">#<span class="number">0</span>  <span class="number">0x00007f27a4aac428</span> in __GI_raise (sig=sig@entry=<span class="number">6</span>) at ../sysdeps/unix/sysv/linux/raise.c:<span class="number">54</span></span><br><span class="line"><span class="number">54</span>      ../sysdeps/unix/sysv/linux/raise.c: No such file <span class="keyword">or</span> directory.</span><br><span class="line">(gdb) bt</span><br><span class="line">#<span class="number">0</span>  <span class="number">0x00007f27a4aac428</span> in __GI_raise (sig=sig@entry=<span class="number">6</span>) at ../sysdeps/unix/sysv/linux/raise.c:<span class="number">54</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x00007f27a4aae02a</span> in __GI_abort () at <span class="built_in">abort</span>.c:<span class="number">89</span></span><br><span class="line">#<span class="number">2</span>  <span class="number">0x00007f27a4aee7ea</span> in __libc_message (do_abort=do_abort@entry=<span class="number">1</span>, fmt=fmt@entry=<span class="number">0x7f27a4c0649f</span> <span class="string">"*** %s ***: %s terminated\n"</span>) at ../sysdeps/posix/libc_fatal.c:<span class="number">175</span></span><br><span class="line">#<span class="number">3</span>  <span class="number">0x00007f27a4b9015c</span> in __GI___fortify_fail (msg=&lt;optimized out&gt;, msg@entry=<span class="number">0x7f27a4c06481</span> <span class="string">"stack smashing detected"</span>) at fortify_fail.c:<span class="number">37</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0x00007f27a4b90100</span> in __stack_chk_fail () at stack_chk_fail.c:<span class="number">28</span></span><br><span class="line">#5  0x000000000040079f in main (argc=1, argv=0x7ffd4b1bfc18) at canary_demo.c:19</span><br></pre></td></tr></table></figure></p>
<p>　　具体解析，gdb运行demo，在17行处打断点，反汇编，抓取寄存器和内存信息。通过*main&lt;+4&gt;可以看到，main的栈帧申请了0x30字节，main&lt;+30&gt;可知stSrc起始在sp-0x10处，可用空间为0x20 - 0x8 = 0x18 bytes。抓寄存器信息，通过RBP获得进程的canary为0xb06404f1 a278ee00。通过RSP dump栈内数据，可以到此时的canary是正常的。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disassemble /m</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> function main:</span><br><span class="line"><span class="number">14</span>      &#123;</span><br><span class="line">   <span class="number">0x0000000000400746</span> &lt;+<span class="number">0</span>&gt;:     push   %rbp</span><br><span class="line">   <span class="number">0x0000000000400747</span> &lt;+<span class="number">1</span>&gt;:     mov    %rsp,%rbp</span><br><span class="line">   <span class="number">0x000000000040074a</span> &lt;+<span class="number">4</span>&gt;:     sub    $<span class="number">0x30</span>,%rsp</span><br><span class="line">   <span class="number">0x000000000040074e</span> &lt;+<span class="number">8</span>&gt;:     mov    %edi,<span class="number">-0x24</span>(%rbp)</span><br><span class="line">   <span class="number">0x0000000000400751</span> &lt;+<span class="number">11</span>&gt;:    mov    %rsi,<span class="number">-0x30</span>(%rbp)</span><br><span class="line">   <span class="number">0x0000000000400755</span> &lt;+<span class="number">15</span>&gt;:    mov    %fs:<span class="number">0x28</span>,%rax</span><br><span class="line">   <span class="number">0x000000000040075e</span> &lt;+<span class="number">24</span>&gt;:    mov    %rax,<span class="number">-0x8</span>(%rbp)</span><br><span class="line">   <span class="number">0x0000000000400762</span> &lt;+<span class="number">28</span>&gt;:    xor    %eax,%eax</span><br><span class="line"></span><br><span class="line"><span class="number">15</span>          <span class="keyword">canary_data_t</span> stSrc;</span><br><span class="line"><span class="number">16</span>          <span class="built_in">memset</span>(&amp;stSrc, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">canary_data_t</span>) );</span><br><span class="line">   <span class="number">0x0000000000400764</span> &lt;+<span class="number">30</span>&gt;:    lea    <span class="number">-0x20</span>(%rbp),%rax</span><br><span class="line">   <span class="number">0x0000000000400768</span> &lt;+<span class="number">34</span>&gt;:    mov    $<span class="number">0x18</span>,%edx</span><br><span class="line">   <span class="number">0x000000000040076d</span> &lt;+<span class="number">39</span>&gt;:    mov    $<span class="number">0x0</span>,%esi</span><br><span class="line">   <span class="number">0x0000000000400772</span> &lt;+<span class="number">44</span>&gt;:    mov    %rax,%rdi</span><br><span class="line">   <span class="number">0x0000000000400775</span> &lt;+<span class="number">47</span>&gt;:    callq  <span class="number">0x400620</span> &lt;<span class="built_in">memset</span>@plt&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">17</span>          overWriteData(&amp;stSrc);</span><br><span class="line">=&gt; <span class="number">0x000000000040077a</span> &lt;+<span class="number">52</span>&gt;:    lea    <span class="number">-0x20</span>(%rbp),%rax</span><br><span class="line">   <span class="number">0x000000000040077e</span> &lt;+<span class="number">56</span>&gt;:    mov    %rax,%rdi</span><br><span class="line">   <span class="number">0x0000000000400781</span> &lt;+<span class="number">59</span>&gt;:    callq  <span class="number">0x400600</span> &lt;overWriteData@plt&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">18</span>          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   <span class="number">0x0000000000400786</span> &lt;+<span class="number">64</span>&gt;:    mov    $<span class="number">0x0</span>,%eax</span><br><span class="line"></span><br><span class="line"><span class="number">19</span>      &#125;</span><br><span class="line">   <span class="number">0x000000000040078b</span> &lt;+<span class="number">69</span>&gt;:    mov    <span class="number">-0x8</span>(%rbp),%rcx</span><br><span class="line">   <span class="number">0x000000000040078f</span> &lt;+<span class="number">73</span>&gt;:    xor    %fs:<span class="number">0x28</span>,%rcx</span><br><span class="line">   <span class="number">0x0000000000400798</span> &lt;+<span class="number">82</span>&gt;:    je     <span class="number">0x40079f</span> &lt;main+<span class="number">89</span>&gt;</span><br><span class="line">   <span class="number">0x000000000040079a</span> &lt;+<span class="number">84</span>&gt;:    callq  <span class="number">0x400610</span> &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">   <span class="number">0x000000000040079f</span> &lt;+<span class="number">89</span>&gt;:    leaveq </span><br><span class="line">   <span class="number">0x00000000004007a0</span> &lt;+<span class="number">90</span>&gt;:    retq   </span><br><span class="line"></span><br><span class="line">(gdb) i registers </span><br><span class="line">rbp            <span class="number">0x7fffffffe3a0</span>   <span class="number">0x7fffffffe3a0</span></span><br><span class="line">rsp            <span class="number">0x7fffffffe370</span>   <span class="number">0x7fffffffe370</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(gdb) x/<span class="number">2</span>x <span class="number">0x7fffffffe3a0</span><span class="number">-0x8</span></span><br><span class="line"><span class="number">0x7fffffffe398</span>: <span class="number">0xa278ee00</span>      <span class="number">0xb06404f1</span></span><br><span class="line"></span><br><span class="line">(gdb) x/<span class="number">16</span>x <span class="number">0x7fffffffe370</span></span><br><span class="line"><span class="number">0x7fffffffe370</span>: <span class="number">0xffffe488</span>      <span class="number">0x00007fff</span>      <span class="number">0x00000000</span>      <span class="number">0x00000001</span></span><br><span class="line"><span class="number">0x7fffffffe380</span>: <span class="number">0x00000000</span>      <span class="number">0x00000000</span>      <span class="number">0x00000000</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7fffffffe390</span>: <span class="number">0x00000000</span>      <span class="number">0x00000000</span>      <span class="number">0xa278ee00</span>      <span class="number">0xb06404f1</span></span><br><span class="line"><span class="number">0x7fffffffe3a0</span>: <span class="number">0x004007b0</span>      <span class="number">0x00000000</span>      <span class="number">0xf782b830</span>      <span class="number">0x00007fff</span></span><br></pre></td></tr></table></figure></p>
<p>　　单步执行进入overWriteData，对16、17行打断点,执行同main函数的步骤，我们可以看到overWriteData函数的帧大小为0x40，因此在0x7fffffffe320到0x7fffffffe35F之间，对stDes的操作不会踩到canary，在执行memcpy之前，main和overWriteData的栈内存如下。两个canary都完好。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/<span class="number">2</span>x <span class="number">0x7fffffffe360</span><span class="number">-0x8</span></span><br><span class="line"><span class="number">0x7fffffffe358</span>: <span class="number">0xa278ee00</span>      <span class="number">0xb06404f1</span></span><br><span class="line"></span><br><span class="line">(gdb) x/<span class="number">32</span>x <span class="number">0x7fffffffe320</span>  </span><br><span class="line"><span class="number">0x7fffffffe320</span>: <span class="number">0xffffe380</span>      <span class="number">0x00007fff</span>      <span class="number">0xffffe380</span>      <span class="number">0x00007fff</span></span><br><span class="line"><span class="number">0x7fffffffe330</span>: <span class="number">0xf7de7ab0</span>      <span class="number">0x00007fff</span>      <span class="number">0x00000000</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7fffffffe340</span>: <span class="number">0xff000000</span>      <span class="number">0x00000000</span>      <span class="number">0xff000000</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7fffffffe350</span>: <span class="number">0x00000000</span>      <span class="number">0x00000000</span>      <span class="number">0xa278ee00</span>      <span class="number">0xb06404f1</span></span><br><span class="line"><span class="number">0x7fffffffe360</span>: <span class="number">0xffffe3a0</span>      <span class="number">0x00007fff</span>      <span class="number">0x00400786</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7fffffffe370</span>: <span class="number">0xffffe488</span>      <span class="number">0x00007fff</span>      <span class="number">0x00000000</span>      <span class="number">0x00000001</span></span><br><span class="line"><span class="number">0x7fffffffe380</span>: <span class="number">0x00000000</span>      <span class="number">0x00000000</span>      <span class="number">0x00000000</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7fffffffe390</span>: <span class="number">0x00000000</span>      <span class="number">0x00000000</span>      <span class="number">0xa278ee00</span>      <span class="number">0xb06404f1</span></span><br></pre></td></tr></table></figure></p>
<p>　　单步执行到返回语句处，在执行完cpy操作后，我们可以看到此时，main函数的栈canary已经被踩，而overWriteData则完好，因此后者返回时正常，但返回到main函数时，在从main函数返回时，canary检测到越界访问，因此coredump退出，问题出现。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">Breakpoint <span class="number">3</span>, overWriteData (stSrc=<span class="number">0x7fffffffe380</span>) at libDemoCanary.c:<span class="number">17</span></span><br><span class="line"><span class="number">17</span>          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">(gdb) x/<span class="number">32</span>x <span class="number">0x7fffffffe320</span></span><br><span class="line"><span class="number">0x7fffffffe320</span>: <span class="number">0xffffe380</span>      <span class="number">0x00007fff</span>      <span class="number">0xffffe380</span>      <span class="number">0x00007fff</span></span><br><span class="line"><span class="number">0x7fffffffe330</span>: <span class="number">0x0000000a</span>      <span class="number">0x00000014</span>      <span class="number">0x0000001e</span>      <span class="number">0x00000028</span></span><br><span class="line"><span class="number">0x7fffffffe340</span>: <span class="number">0x00000000</span>      <span class="number">0x00000000</span>      <span class="number">0x00000000</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7fffffffe350</span>: <span class="number">0x00000000</span>      <span class="number">0x00000000</span>      <span class="number">0xa278ee00</span>      <span class="number">0xb06404f1</span></span><br><span class="line"><span class="number">0x7fffffffe360</span>: <span class="number">0xffffe3a0</span>      <span class="number">0x00007fff</span>      <span class="number">0x00400786</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x7fffffffe370</span>: <span class="number">0xffffe488</span>      <span class="number">0x00007fff</span>      <span class="number">0x00000000</span>      <span class="number">0x00000001</span></span><br><span class="line"><span class="number">0x7fffffffe380</span>: <span class="number">0x0000000a</span>      <span class="number">0x00000014</span>      <span class="number">0x0000001e</span>      <span class="number">0x00000028</span></span><br><span class="line">0x7fffffffe390: 0x00000000      0x00000000      '0x00000000'    0xb06404f1</span><br></pre></td></tr></table></figure></p>
<h3 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h3><p>　　通过上面这个bug，我过了一遍GCC的缓冲区溢出攻击保护机制，实际也学到了好些新的知识，毕竟这么底层的东西，平时也是比较少会接触到的。这时候也发现GDB在这种场景分析中十分实用。我在学习C++的虚函数原理时，也通过x/32i看到可执行代码部分的实现，收获颇多，多接触这种底层机理的了解也有助于我们更进一步写出好的程序。</p>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p>PLAYING WITH CANARIES <a href="https://www.elttam.com.au/blog/playing-with-canaries/" target="_blank" rel="noopener">https://www.elttam.com.au/blog/playing-with-canaries/</a><br>canary analysis <a href="https://hardenedlinux.github.io/2016/11/27/canary.html" target="_blank" rel="noopener">https://hardenedlinux.github.io/2016/11/27/canary.html</a><br>Stack Smashing Protector <a href="https://wiki.osdev.org/Stack_Smashing_Protector" target="_blank" rel="noopener">https://wiki.osdev.org/Stack_Smashing_Protector</a><br>Stack Smashing On A Modern Linux System <a href="https://www.exploit-db.com/papers/24085/" target="_blank" rel="noopener">https://www.exploit-db.com/papers/24085/</a><br>函数调用过程探究 <a href="http://www.cnblogs.com/bangerlee/archive/2012/05/22/2508772.html" target="_blank" rel="noopener">http://www.cnblogs.com/bangerlee/archive/2012/05/22/2508772.html</a><br>fs:0x28介绍 <a href="https://stackoverflow.com/questions/10325713/why-does-this-memory-address-fs0x28-fs0x28-have-a-random-value" target="_blank" rel="noopener">https://stackoverflow.com/questions/10325713/why-does-this-memory-address-fs0x28-fs0x28-have-a-random-value</a> </p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Donald.Zhuang
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://donald-zhuang.github.io/2018/07/21/Tips-About-Canary-in-GCC-SSP/" title="GCC SSP Canary功能简介">https://donald-zhuang.github.io/2018/07/21/Tips-About-Canary-in-GCC-SSP/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/canary/" rel="tag"># canary</a>
          
            <a href="/tags/coredump/" rel="tag"># coredump</a>
          
            <a href="/tags/stack-chk-fail/" rel="tag"># __stack_chk_fail</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/08/ChunQiu/" rel="next" title="春秋">
                <i class="fa fa-chevron-left"></i> 春秋
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/04/my-rules/" rel="prev" title="行事三原则">
                行事三原则 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="Donald.Zhuang" />
            
              <p class="site-author-name" itemprop="name">Donald.Zhuang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/donald-zhuang" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yukunzhuang@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-背景"><span class="nav-number">1.</span> <span class="nav-text">1. 背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-GCC-SSP的canary基本原理"><span class="nav-number">2.</span> <span class="nav-text">2. GCC SSP的canary基本原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-功能使能方式"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 功能使能方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-功能缺陷"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 功能缺陷</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-canary的产生"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 canary的产生</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-1-Canary常见类型"><span class="nav-number">2.3.1.</span> <span class="nav-text">2.3.1 Canary常见类型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-2-GCC-Canary生成原理"><span class="nav-number">2.3.2.</span> <span class="nav-text">2.3.2 GCC Canary生成原理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Canary-Bug-一例"><span class="nav-number">3.</span> <span class="nav-text">3. Canary Bug 一例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-总结"><span class="nav-number">4.</span> <span class="nav-text">4. 总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考文献"><span class="nav-number">5.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Donald.Zhuang</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'sxusj7QM1yscw80QmXrzS7RF-gzGzoHsz',
        appKey: 'LKGpEcrVf998QJrYCHajJsT8',
        placeholder: 'Just go go',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: true,
    });
  </script>



  





  

  

  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>


  

</body>
</html>
